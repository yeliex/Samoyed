(function(m,k,n){var o=m.setTimeout,l={};function j(c){var d=c.required_features,b={};function a(h,g,e){var f={chunks:"slice_blob",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",urlstream_upload:"send_binary_string",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};if(f[h]){b[f[h]]=g}else{if(!e){b[h]=g}}}if(typeof(d)==="string"){p.each(d.split(/\s*,\s*/),function(e){a(e,true)})}else{if(typeof(d)==="object"){p.each(d,function(f,e){a(e,f)})}else{if(d===true){if(c.chunk_size>0){b.slice_blob=true}if(c.resize.enabled||!c.multipart){b.send_binary_string=true}p.each(c,function(f,e){a(e,!!f,true)})}}}return b}var p={VERSION:"2.1.7",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:k.mimes,ua:k.ua,typeOf:k.typeOf,extend:k.extend,guid:k.guid,get:function i(a){var c=[],b;if(k.typeOf(a)!=="array"){a=[a]}var d=a.length;while(d--){b=k.get(a[d]);if(b){c.push(b)}}return c.length?c:null},each:k.each,getPos:k.getPos,getSize:k.getSize,xmlEncode:function(b){var a={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},c=/[<>&\"\']/g;return b?(""+b).replace(c,function(d){return a[d]?"&"+a[d]+";":d}):b},toArray:k.toArray,inArray:k.inArray,addI18n:k.addI18n,translate:k.translate,isEmptyObj:k.isEmptyObj,hasClass:k.hasClass,addClass:k.addClass,removeClass:k.removeClass,getStyle:k.getStyle,addEvent:k.addEvent,removeEvent:k.removeEvent,removeAllEvents:k.removeAllEvents,cleanName:function(c){var b,a;a=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(b=0;b<a.length;b+=2){c=c.replace(a[b],a[b+1])}c=c.replace(/\s+/g,"_");c=c.replace(/[^a-z0-9_\-\.]+/gi,"");return c},buildUrl:function(b,c){var a="";p.each(c,function(d,e){a+=(a?"&":"")+encodeURIComponent(e)+"="+encodeURIComponent(d)});if(a){b+=(b.indexOf("?")>0?"&":"?")+a}return b},formatSize:function(b){if(b===n||/\D/.test(b)){return p.translate("N/A")}function c(d,e){return Math.round(d*Math.pow(10,e))/Math.pow(10,e)}var a=Math.pow(1024,4);if(b>a){return c(b/a,1)+" "+p.translate("tb")}if(b>(a/=1024)){return c(b/a,1)+" "+p.translate("gb")}if(b>(a/=1024)){return c(b/a,1)+" "+p.translate("mb")}if(b>1024){return Math.round(b/1024)+" "+p.translate("kb")}return b+" "+p.translate("b")},parseSize:k.parseSizeStr,predictRuntime:function(b,c){var d,a;d=new p.Uploader(b);a=k.Runtime.thatCan(d.getOption().required_features,c||b.runtimes);d.destroy();return a},addFileFilter:function(a,b){l[a]=b}};p.addFileFilter("mime_types",function(a,b,c){if(a.length&&!a.regexp.test(b.name)){this.trigger("Error",{code:p.FILE_EXTENSION_ERROR,message:p.translate("File extension error."),file:b});c(false)}else{c(true)}});p.addFileFilter("max_file_size",function(a,c,d){var b;a=p.parseSize(a);if(c.size!==b&&a&&c.size>a){this.trigger("Error",{code:p.FILE_SIZE_ERROR,message:p.translate("File size error."),file:c});d(false)}else{d(true)}});p.addFileFilter("prevent_duplicates",function(a,c,d){if(a){var b=this.files.length;while(b--){if(c.name===this.files[b].name&&c.size===this.files[b].size){this.trigger("Error",{code:p.FILE_DUPLICATE_ERROR,message:p.translate("Duplicate file error."),file:c});d(false);return}}}d(true)});p.Uploader=function(aa){var O=p.guid(),h,W=[],e={},M=[],g=[],S,b,Y=false,K;function d(){var q,s=0,r;if(this.state==p.STARTED){for(r=0;r<W.length;r++){if(!q&&W[r].status==p.QUEUED){q=W[r];if(this.trigger("BeforeUpload",q)){q.status=p.UPLOADING;this.trigger("UploadFile",q)}}else{s++}}if(s==W.length){if(this.state!==p.STOPPED){this.state=p.STOPPED;this.trigger("StateChanged")}this.trigger("UploadComplete",W)}}}function ab(q){q.percent=q.size>0?Math.ceil(q.loaded/q.size*100):100;ac()}function ac(){var q,r;b.reset();for(q=0;q<W.length;q++){r=W[q];if(r.size!==n){b.size+=r.origSize;b.loaded+=r.loaded*r.origSize/r.size}else{b.size=n}if(r.status==p.DONE){b.uploaded++}else{if(r.status==p.FAILED){b.failed++}else{b.queued++}}}if(b.size===n){b.percent=W.length>0?Math.ceil(b.uploaded/W.length*100):0}else{b.bytesPerSec=Math.ceil(b.loaded/((+new Date()-S||1)/1000));b.percent=b.size>0?Math.ceil(b.loaded/b.size*100):0}}function f(){var q=M[0]||g[0];if(q){return q.getRuntime().uid}return false}function N(q,r){if(q.ruid){var s=k.Runtime.getInfo(q.ruid);if(s){return s.can(r)}}return false}function c(){this.bind("FilesAdded FilesRemoved",function(q){q.trigger("QueueChanged");q.refresh()});this.bind("CancelUpload",ad);this.bind("BeforeUpload",U);this.bind("UploadFile",Q);this.bind("UploadProgress",L);this.bind("StateChanged",V);this.bind("QueueChanged",ac);this.bind("Error",R);this.bind("FileUploaded",P);this.bind("Destroy",T)}function a(s,v){var u=this,q=0,r=[];var t={runtime_order:s.runtimes,required_caps:s.required_features,preferred_caps:e,swf_url:s.flash_swf_url,xap_url:s.silverlight_xap_url};p.each(s.runtimes.split(/\s*,\s*/),function(w){if(s[w]){t[w]=s[w]}});if(s.browse_button){p.each(s.browse_button,function(w){r.push(function(y){var x=new k.FileInput(p.extend({},t,{accept:s.filters.mime_types,name:s.file_data_name,multiple:s.multi_selection,container:s.container,browse_button:w}));x.onready=function(){var z=k.Runtime.getInfo(this.ruid);k.extend(u.features,{chunks:z.can("slice_blob"),multipart:z.can("send_multipart"),multi_selection:z.can("select_multiple")});q++;M.push(this);y()};x.onchange=function(){u.addFile(this.files)};x.bind("mouseenter mouseleave mousedown mouseup",function(z){if(!Y){if(s.browse_button_hover){if("mouseenter"===z.type){k.addClass(w,s.browse_button_hover)}else{if("mouseleave"===z.type){k.removeClass(w,s.browse_button_hover)}}}if(s.browse_button_active){if("mousedown"===z.type){k.addClass(w,s.browse_button_active)}else{if("mouseup"===z.type){k.removeClass(w,s.browse_button_active)}}}}});x.bind("mousedown",function(){u.trigger("Browse")});x.bind("error runtimeerror",function(){x=null;y()});x.init()})})}if(s.drop_element){p.each(s.drop_element,function(w){r.push(function(y){var x=new k.FileDrop(p.extend({},t,{drop_zone:w}));x.onready=function(){var z=k.Runtime.getInfo(this.ruid);u.features.dragdrop=z.can("drag_and_drop");q++;g.push(this);y()};x.ondrop=function(){u.addFile(this.files)};x.bind("error runtimeerror",function(){x=null;y()});x.init()})})}k.inSeries(r,function(){if(typeof(v)==="function"){v(q)}})}function X(u,s,r){var q=new k.Image();try{q.onload=function(){if(s.width>this.width&&s.height>this.height&&s.quality===n&&s.preserve_headers&&!s.crop){this.destroy();return r(u)}q.downsize(s.width,s.height,s.crop,s.preserve_headers)};q.onresize=function(){r(this.getAsBlob(u.type,s.quality));this.destroy()};q.onerror=function(){r(u)};q.load(u)}catch(t){r(u)}}function Z(v,t,s){var q=this,r=false;function u(y,x,w){var z=h[y];switch(y){case"max_file_size":if(y==="max_file_size"){h.max_file_size=h.filters.max_file_size=x}break;case"chunk_size":if(x=p.parseSize(x)){h[y]=x;h.send_file_name=true}break;case"multipart":h[y]=x;if(!x){h.send_file_name=true}break;case"unique_names":h[y]=x;if(x){h.send_file_name=true}break;case"filters":if(p.typeOf(x)==="array"){x={mime_types:x}}if(w){p.extend(h.filters,x)}else{h.filters=x}if(x.mime_types){h.filters.mime_types.regexp=(function(B){var A=[];p.each(B,function(C){p.each(C.extensions.split(/,/),function(D){if(/^\s*\*\s*$/.test(D)){A.push("\\.*")}else{A.push("\\."+D.replace(new RegExp("["+("/^$.*+?|()[]{}\\".replace(/./g,"\\$&"))+"]","g"),"\\$&"))}})});return new RegExp("("+A.join("|")+")$","i")}(h.filters.mime_types))}break;case"resize":if(w){p.extend(h.resize,x,{enabled:true})}else{h.resize=x}break;case"prevent_duplicates":h.prevent_duplicates=h.filters.prevent_duplicates=!!x;break;case"browse_button":case"drop_element":x=p.get(x);case"container":case"runtimes":case"multi_selection":case"flash_swf_url":case"silverlight_xap_url":h[y]=x;if(!w){r=true}break;default:h[y]=x}if(!w){q.trigger("OptionChanged",y,x,z)}}if(typeof(v)==="object"){p.each(v,function(w,x){u(x,w,s)})}else{u(v,t,s)}if(s){h.required_features=j(p.extend({},h));e=j(p.extend({},h,{required_features:true}))}else{if(r){q.trigger("Destroy");a.call(q,h,function(w){if(w){q.runtime=k.Runtime.getInfo(f()).type;q.trigger("Init",{runtime:q.runtime});q.trigger("PostInit")}else{q.trigger("Error",{code:p.INIT_ERROR,message:p.translate("Init error.")})}})}}}function U(r,q){if(r.settings.unique_names){var s=q.name.match(/\.([^.]+)$/),t="part";if(s){t=s[1]}q.target_name=q.id+"."+t}}function Q(r,u){var x=r.settings.url,t=r.settings.chunk_size,q=r.settings.max_retries,w=r.features,s=0,z;if(u.loaded){s=u.loaded=t?t*Math.floor(u.loaded/t):0}function v(){if(q-->0){o(y,1000)}else{u.loaded=s;r.trigger("Error",{code:p.HTTP_ERROR,message:p.translate("HTTP Error."),file:u,response:K.responseText,status:K.status,responseHeaders:K.getAllResponseHeaders()})}}function y(){var A,B,C={},D;if(u.status!==p.UPLOADING||r.state===p.STOPPED){return}if(r.settings.send_file_name){C.name=u.target_name||u.name}if(t&&w.chunks&&z.size>t){D=Math.min(t,z.size-s);A=z.slice(s,s+D)}else{D=z.size;A=z}if(t&&w.chunks){if(r.settings.send_chunk_number){C.chunk=Math.ceil(s/t);C.chunks=Math.ceil(z.size/t)}else{C.offset=s;C.total=z.size}}K=new k.XMLHttpRequest();if(K.upload){K.upload.onprogress=function(E){u.loaded=Math.min(u.size,s+E.loaded);r.trigger("UploadProgress",u)}}K.onload=function(){if(K.status>=400){v();return}q=r.settings.max_retries;if(D<z.size){A.destroy();s+=D;u.loaded=Math.min(s,z.size);r.trigger("ChunkUploaded",u,{offset:u.loaded,total:z.size,response:K.responseText,status:K.status,responseHeaders:K.getAllResponseHeaders()});if(k.Env.browser==="Android Browser"){r.trigger("UploadProgress",u)}}else{u.loaded=u.size}A=B=null;if(!s||s>=z.size){if(u.size!=u.origSize){z.destroy();z=null}r.trigger("UploadProgress",u);u.status=p.DONE;r.trigger("FileUploaded",u,{response:K.responseText,status:K.status,responseHeaders:K.getAllResponseHeaders()})}else{o(y,1)}};K.onerror=function(){v()};K.onloadend=function(){this.destroy();K=null};if(r.settings.multipart&&w.multipart){K.open("post",x,true);p.each(r.settings.headers,function(E,F){K.setRequestHeader(F,E)});B=new k.FormData();p.each(p.extend(C,r.settings.multipart_params),function(E,F){B.append(F,E)});B.append(r.settings.file_data_name,A);K.send(B,{runtime_order:r.settings.runtimes,required_caps:r.settings.required_features,preferred_caps:e,swf_url:r.settings.flash_swf_url,xap_url:r.settings.silverlight_xap_url})}else{x=p.buildUrl(r.settings.url,p.extend(C,r.settings.multipart_params));K.open("post",x,true);K.setRequestHeader("Content-Type","application/octet-stream");p.each(r.settings.headers,function(E,F){K.setRequestHeader(F,E)});K.send(A,{runtime_order:r.settings.runtimes,required_caps:r.settings.required_features,preferred_caps:e,swf_url:r.settings.flash_swf_url,xap_url:r.settings.silverlight_xap_url})}}z=u.getSource();if(r.settings.resize.enabled&&N(z,"send_binary_string")&&!!~k.inArray(z.type,["image/jpeg","image/png"])){X.call(this,z,r.settings.resize,function(A){z=A;u.size=A.size;y()})}else{y()}}function L(r,q){ab(q)}function V(r){if(r.state==p.STARTED){S=(+new Date())}else{if(r.state==p.STOPPED){for(var q=r.files.length-1;q>=0;q--){if(r.files[q].status==p.UPLOADING){r.files[q].status=p.QUEUED;ac()}}}}}function ad(){if(K){K.abort()}}function P(q){ac();o(function(){d.call(q)},1)}function R(r,q){if(q.code===p.INIT_ERROR){r.destroy()}else{if(q.code===p.HTTP_ERROR){q.file.status=p.FAILED;ab(q.file);if(r.state==p.STARTED){r.trigger("CancelUpload");o(function(){d.call(r)},1)}}}}function T(q){q.stop();p.each(W,function(r){r.destroy()});W=[];if(M.length){p.each(M,function(r){r.destroy()});M=[]}if(g.length){p.each(g,function(r){r.destroy()});g=[]}e={};Y=false;S=K=null;b.reset()}h={runtimes:k.Runtime.order,max_retries:0,chunk_size:0,multipart:true,multi_selection:true,file_data_name:"file",flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",filters:{mime_types:[],prevent_duplicates:false,max_file_size:0},resize:{enabled:false,preserve_headers:true,crop:false},send_file_name:true,send_chunk_number:true};Z.call(this,aa,null,true);b=new p.QueueProgress();p.extend(this,{id:O,uid:O,state:p.STOPPED,features:{},runtime:null,files:W,settings:h,total:b,init:function(){var q=this;if(typeof(h.preinit)=="function"){h.preinit(q)}else{p.each(h.preinit,function(s,r){q.bind(r,s)})}c.call(this);if(!h.browse_button||!h.url){this.trigger("Error",{code:p.INIT_ERROR,message:p.translate("Init error.")});return}a.call(this,h,function(r){if(typeof(h.init)=="function"){h.init(q)}else{p.each(h.init,function(s,t){q.bind(t,s)})}if(r){q.runtime=k.Runtime.getInfo(f()).type;q.trigger("Init",{runtime:q.runtime});q.trigger("PostInit")}else{q.trigger("Error",{code:p.INIT_ERROR,message:p.translate("Init error.")})}})},setOption:function(r,q){Z.call(this,r,q,!this.runtime)},getOption:function(q){if(!q){return h}return h[q]},refresh:function(){if(M.length){p.each(M,function(q){q.trigger("Refresh")})}this.trigger("Refresh")},start:function(){if(this.state!=p.STARTED){this.state=p.STARTED;this.trigger("StateChanged");d.call(this)}},stop:function(){if(this.state!=p.STOPPED){this.state=p.STOPPED;this.trigger("StateChanged");this.trigger("CancelUpload")}},disableBrowse:function(){Y=arguments[0]!==n?arguments[0]:true;if(M.length){p.each(M,function(q){q.disable(Y)})}this.trigger("DisableBrowse",Y)},getFile:function(q){var r;for(r=W.length-1;r>=0;r--){if(W[r].id===q){return W[r]}}},addFile:function(u,s){var x=this,r=[],q=[],w;function t(y,z){var A=[];k.each(x.settings.filters,function(B,C){if(l[C]){A.push(function(D){l[C].call(x,B,y,function(E){D(!E)})})}});k.inSeries(A,z)}function v(z){var y=k.typeOf(z);if(z instanceof k.File){if(!z.ruid&&!z.isDetached()){if(!w){return false}z.ruid=w;z.connectRuntime(w)}v(new p.File(z))}else{if(z instanceof k.Blob){v(z.getSource());z.destroy()}else{if(z instanceof p.File){if(s){z.name=s}r.push(function(A){t(z,function(B){if(!B){W.push(z);q.push(z);x.trigger("FileFiltered",z)}o(A,1)})})}else{if(k.inArray(y,["file","blob"])!==-1){v(new k.File(null,z))}else{if(y==="node"&&k.typeOf(z.files)==="filelist"){k.each(z.files,v)}else{if(y==="array"){s=null;k.each(z,v)}}}}}}}w=f();v(u);if(r.length){k.inSeries(r,function(){if(q.length){x.trigger("FilesAdded",q)}})}},removeFile:function(q){var s=typeof(q)==="string"?q:q.id;for(var r=W.length-1;r>=0;r--){if(W[r].id===s){return this.splice(r,1)[0]}}},splice:function(s,r){var q=W.splice(s===n?0:s,r===n?W.length:r);var t=false;if(this.state==p.STARTED){p.each(q,function(u){if(u.status===p.UPLOADING){t=true;return false}});if(t){this.stop()}}this.trigger("FilesRemoved",q);p.each(q,function(u){u.destroy()});if(t){this.start()}return q},bind:function(q,s,t){var r=this;p.Uploader.prototype.bind.call(this,q,function(){var u=[].slice.call(arguments);u.splice(0,1,r);return s.apply(this,u)},0,t)},destroy:function(){this.trigger("Destroy");h=b=null;this.unbindAll()}})};p.Uploader.prototype=k.EventTarget.instance;p.File=(function(){var a={};function b(c){p.extend(this,{id:p.guid(),name:c.name||c.fileName,type:c.type||"",size:c.size||c.fileSize,origSize:c.size||c.fileSize,loaded:0,percent:0,status:p.QUEUED,lastModifiedDate:c.lastModifiedDate||(new Date()).toLocaleString(),getNative:function(){var d=this.getSource().getSource();return k.inArray(k.typeOf(d),["blob","file"])!==-1?d:null},getSource:function(){if(!a[this.id]){return null}return a[this.id]},destroy:function(){var d=this.getSource();if(d){d.destroy();delete a[this.id]}}});a[this.id]=c}return b}());p.QueueProgress=function(){var a=this;a.size=0;a.loaded=0;a.uploaded=0;a.failed=0;a.queued=0;a.percent=0;a.bytesPerSec=0;a.reset=function(){a.size=a.loaded=a.uploaded=a.failed=a.queued=a.percent=a.bytesPerSec=0}};m.plupload=p}(window,mOxie));