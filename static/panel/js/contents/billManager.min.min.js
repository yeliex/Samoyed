$(function(){$("#select-district .ui.dropdown").dropdown();districtSelect(0)});function districtSelect(h){clearEdit();var g=getList(h);var f=g.num;$(".table#list tbody").html("");for(var e=0;e<f;e++){displayList(g.data[e])}$("#bill_manager #list_num span").text(f)}function getList(d){var f;var e=$.ajax("http://api.panel.mzapp.info/billmanager/billlist/",{method:"GET",async:false,data:{protocol:"json",district:d}});e.complete(function(a){f=$.parseJSON(a.responseText);if(f.status!="success"){alert("获取失败,请重试\n\n"+f.error_info);return}});return f.data}function displayList(d){d=new BuildingData(d);var c="<tr id='"+d.id+"'>";c+="<td>"+d.id+"</td><td>"+d.name+"</td><td>"+d.dadd+"</td>";c+="<td>"+d.price+"</td><td>"+d.size+"</td><td>"+d.units_num+"</td><td>"+d.images_num+"</td>";c+="<td><div class='ui teal small buttons preview'><div class='ui button primary'>查看</div>";c+="<div class='ui floating dropdown icon button'>";c+="<i class='dropdown icon'></i><div class='menu'>";c+="<div class='item detail' data-value='preview-detail'>详情页</div><div class='ui divider'></div><div class='item main-image' data-value='preview-main-image'>主图</div><div class='item units' data-value='preview-units'>户型</div><div class='item images' data-value='preview-images'>其他图片</div>";c+="</div></div></div></td>";c+="<td><div class='ui red small buttons edit'><div class='ui button primary'>修改</div>";c+="<div class='ui floating dropdown icon button'>";c+="<i class='dropdown icon'></i><div class='menu'>";c+="<div class='item basic' data-value='edit-basic'>编辑房源</div><div class='item units' data-value='edit-units'>编辑户型</div><div class='item images' data-value='edit-images'>编辑图片</div><div class='divider'></div><div class='item remove' data-value='edit-remove'>删除</div>";c+="</div></div></div></td></tr>";$(".table#list tbody").append(c);activeDrop(d.id)}function BuildingData(b){this.id=b.dog_id;this.name=b.dog_name;this.district=b.dog_district;this.area=b.dog_area;this.add=b.dog_add;this.dadd=b.dog_district+"-"+b.dog_area+"-"+b.dog_add;this.size=b.dog_size.split("|").join("-");this.price=b.dog_price.split("|").join("-");this.image=b.dog_pic;this.units_num=b.units_num;this.images_num=b.images_num;this.metro=b.dog_metro.split("|");this.pos=b.dog_pos.split("|");this.description=b.dog_description}function UnitData(b){this.id=b.unit_id;this.name=b.unit_name;this.size=b.unit_size;this.price=b.unit_price;this.image=b.unit_pic;this.decoration=b.unit_deco}function ImageData(b){this.id=b.image_id;this.name=b.image_name;this.url=b.image_url;this.avaliable=b.image_avaliable}function NewBasicData(){this.id=$(".edit.edit-basic .header span").text();this.name=$(".edit.edit-basic .form #basic input").val();this.extract={metro:{line_1:$($("#metro .checkbox")[0]).checkbox("is checked"),line_2:$($("#metro .checkbox")[1]).checkbox("is checked"),line_4:$($("#metro .checkbox")[2]).checkbox("is checked"),line_5:$($("#metro .checkbox")[3]).checkbox("is checked"),line_6:$($("#metro .checkbox")[4]).checkbox("is checked")},description:$("#description textarea").val()};this.address={district:$("#district").val(),area:$("#area").val(),address:$("#add").val(),pos:{posx:$("#posx").val(),posy:$("#posy").val()}}}function activeDrop(b){$("#"+b+" .preview .ui.dropdown").dropdown({onChange:function(a){switch(a){case"preview-detail":previewDetail(b);break;case"preview-main-image":previewImage(b);break;case"preview-units":previewUnits(b);break;case"preview-images":previewImages(b);break}}});$("#"+b+" .edit .ui.dropdown").dropdown({onChange:function(a){switch(a){case"edit-basic":editBasic(b);break;case"edit-main-image":editMainImage(b);break;case"edit-units":editUnits(b);break;case"edit-images":editImages(b);break;case"edit-remove":editRemove(b);break}}})}function previewDetail(c){var d="http://mizhi.pub/detail?id="+c;window.open(d)}function previewImage(g){var h;var e=$.ajax("http://api.panel.mzapp.info/billmanager/getImage",{method:"GET",async:false,data:{protocol:"json",id:g}});e.complete(function(a){h=$.parseJSON(a.responseText);if(h.status!="success"){alert("获取失败,请重试\n\n"+h.error_info);return}else{h=h.data}});var f=h.url;$(".ui.modal.preview.main-image .header span").text(g);if(String(g).length==12){$(".ui.modal.preview.main-image .header span").append(" 户型图片")}else{$(".ui.modal.preview.main-image .header span").append(" 房源主图")}$(".ui.modal.preview.main-image img").attr("src",f);$(".ui.modal.preview.main-image").modal("show")}function previewUnits(j){var l;var m=$.ajax("http://api.panel.mzapp.info/billmanager/getUnits",{method:"GET",async:false,data:{protocol:"json",id:j}});m.complete(function(a){l=$.parseJSON(a.responseText);if(l.status!="success"){alert("获取失败,请重试\n\n"+l.error_info);return}else{l=l.data}});$(".ui.modal.preview.units .content table tbody").html("");for(var h=0;h<l.length;h++){var g=new UnitData(l[h]);var k="<tr id='"+g.id+"'>";k+="<td>"+g.id+"</td><td>"+g.name+"</td><td>"+g.size+"</td><td>"+g.price+"</td><td>"+g.decoration+"</td>";k+="<td><div class='ui small button teal' onclick='previewImage("+g.id+")'>查看</div></td>";k+="</tr>";$(".ui.modal.preview.units .content table tbody").append(k)}$(".ui.modal.preview.units .content table thead tr th span").text(l.length);$(".ui.modal.preview.units header span").text(j);$(".ui.modal.preview.units").modal("show")}function previewImages(j){var m;var g=$.ajax("http://api.panel.mzapp.info/billmanager/getImages",{method:"GET",async:false,data:{protocol:"json",id:j}});g.complete(function(a){m=$.parseJSON(a.responseText);if(m.status!="success"){alert("获取失败,请重试\n\n"+m.error_info);return}else{m=m.data}});$(".ui.modal.preview.images .content .images").html("");for(var h=0;h<m.length;h++){var l=new ImageData(m[h]);var k="<div class='ui segment'>";k+="<div class='ui bottom attached label'>"+l.name+"</div>";k+="<img class='ui image' src='"+l.url+"' id='"+l.id+"'>";k+="</div>";$(".ui.modal.preview.images .content .images").append(k)}$(".ui.modal.preview.images .header span").text(j+"  图片数: "+m.length);$(".ui.modal.preview.images").modal("show")}function editBasic(f){clearEdit();var d;var e=$.ajax("http://api.panel.mzapp.info/billmanager/getBasic",{method:"GET",async:false,data:{protocol:"json",id:f}});e.complete(function(b){d=$.parseJSON(b.responseText);if(d.status!="success"){alert("获取失败,请重试\n\n"+d.error_info);return}else{d=d.data;d=new BuildingData(d);$(".ui.modal.edit.edit-basic .header span").text(d.id);$(".ui.modal.edit.edit-basic #basic input").val(d.name);(d.metro[0]=="true")?$($("#metro .checkbox")[0]).checkbox("set checked"):$($("#metro .checkbox")[0]).checkbox();(d.metro[1]=="true")?$($("#metro .checkbox")[1]).checkbox("set checked"):$($("#metro .checkbox")[0]).checkbox();(d.metro[2]=="true")?$($("#metro .checkbox")[2]).checkbox("set checked"):$($("#metro .checkbox")[0]).checkbox();(d.metro[3]=="true")?$($("#metro .checkbox")[3]).checkbox("set checked"):$($("#metro .checkbox")[0]).checkbox();(d.metro[4]=="true")?$($("#metro .checkbox")[4]).checkbox("set checked"):$($("#metro .checkbox")[0]).checkbox();onMapLoaded(false,d.pos);var a=new AMap.Marker({map:map,position:new AMap.LngLat(d.pos[0],d.pos[1]),icon:"http://webapi.amap.com/images/0.png"});var h=[];h.push("<b>"+d.name+"</b>");h.push(d.dadd);var c=new AMap.InfoWindow({offset:new AMap.Pixel(0,-23),content:h.join("<br>")});c.open(map,a.getPosition());AMap.event.addListener(a,"click",function(g){c.open(map,a.getPosition())});$(".ui.modal.edit.edit-basic #district").val(d.district).dropdown();$(".ui.modal.edit.edit-basic #area").val(d.area).dropdown();$(".ui.modal.edit.edit-basic #add").val(d.add);$(".ui.modal.edit.edit-basic #posx").val(d.pos[0]);$(".ui.modal.edit.edit-basic #posy").val(d.pos[1]);$(".ui.modal.edit.edit-basic #description textarea").val(d.description);$(".ui.modal.edit.edit-basic").modal("setting","closable",false).modal("show").modal({onDeny:function(){$(".ui.modal.edit.edit-basic").modal("hide")},onApprove:function(){var k=new NewBasicData();if(onBasicCheck(k)){var g=$.ajax("http://api.panel.mzapp.info/billmanager/basicsave/?protocol=json",{method:"POST",async:false,data:{data:k}});g.complete(function(m){m=$.parseJSON(m.responseText);if(m.status==="success"){$(".ui.modal.edit.edit-basic").modal("hide");alert("保存成功 现在你可以在 '房源管理' 中管理房源\n\n房源ID: "+m.data.id+"\n房源名字: "+m.data.name);var j=$("#district-select").dropdown("get value");districtSelect(j[0])}else{alert("保存失败\n\n错误: "+m.error_info)}})}}})}})}function editUnits(f){clearEdit();var d;var e=$.ajax("http://api.panel.mzapp.info/billmanager/getUnits",{method:"GET",async:false,data:{protocol:"json",id:f}});e.complete(function(l){d=$.parseJSON(l.responseText);if(d.status!="success"){alert("获取失败,请重试\n\n"+d.error_info)}else{d=d.data;var n=d.length;$(".edit.units .content-wrapper").html("");for(var m=0;m<d.length;m++){var c=new UnitData(d[m]);var a=m+1;var o="户型"+a;var b="<fieldset id='"+c.id+"'><legend>"+o+"</legend>";b+="<div class='ui grid'><div class='ten wide column'>";b+="<div class='fields'><div class='five wide field'>";b+="<label>户型名称</label><input type='text' value='"+c.name+"' placeholder='"+o+"' readonly>";b+="</div>";b+="<div class='five wide field'>";b+="<label>面积 / 平方米</label><input type='text' placeholder='户型面积' value='"+c.size+"' readonly>";b+="</div></div>";b+="<div class='fields'>";b+="<div class='five wide field'>";b+="<label>价格 / 元/天/平方米</label><input type='text' placeholder='户型价格' value='"+c.price+"' readonly>";b+="</div>";b+="<div class='five wide field'>";b+="<label>装修类型</label>";b+="<input value='"+c.decoration+"' readonly></input>";b+="</div></div></div>";b+="<div class='two wide column'><button class='ui red button' onclick='onUnitDelete("+c.id+","+f+")'>删除</button></div>";b+="<div class='four wide column'><div class='field'>";b+="<img class='ui image' src='"+c.image+"'>";b+="</div></div></div></fieldset>";$(".edit.units .content-wrapper").append(b)}$(".edit.units #units_num span").text(n);$(".edit.units .header span").text(f);$(".edit.units").show();$(".ui.button.add.unit").on("click",function(g){g.preventDefault();onEditNewUnitClicked()})}})}function editImages(h){clearEdit();var j;var k=$.ajax("http://api.panel.mzapp.info/billmanager/getImages",{method:"GET",async:false,data:{protocol:"json",id:h}});k.complete(function(d){j=$.parseJSON(d.responseText);if(j.status!="success"){alert("获取失败,请重试\n\n"+j.error_info)}else{j=j.data;var n=j.length;for(i=0;i<n;i++){var c=new ImageData(j[i]);var a=i+1;var o="图片"+a;var e=$(".edit.images .content-wrapper").html();var b="<div class='field' id='"+c.id+"'>";b+="<div class='ui action input'>";b+="<input type='text' placeholder='图片名称' value='"+c.name+"' readonly>";b+="<button class='ui red button' onclick='onImageDelete("+c.id+","+h+")'>删除</button>";b+="</div>";b+="<img class='ui medium image' src='"+c.url+"'>";b+="</div>";if((a-1)%4===0){b="<div class='fields'>"+b}else{if(a%4===0){e=e.substr(0,e.length-6);b+="</div>"}else{e=e.substr(0,e.length-6)}}b+="</div>";b=e+b;$(".edit.images .content-wrapper").html(b)}$(".edit.images #images_num span").text(n);$(".edit.images .header span").text(h);$(".edit.images").show();$(".ui.button.add.images").on("click",function(l){l.preventDefault();onEditNewImageClicked()})}});var g;var f=$.ajax("http://api.panel.mzapp.info/billmanager/getMainImage",{method:"GET",async:false,data:{protocol:"json",id:h}});f.complete(function(a){g=$.parseJSON(a.responseText).data;$(".edit.images #main-image img").attr("src",g.url);$(".edit.images #main-image input").val(g.url)})}function editRemove(c){clearEdit();if(confirm("是否要删除户型: "+c)){var d=$.ajax("http://api.panel.mzapp.info/billmanager/deleteBuilding/",{method:"GET",async:false,data:{protocol:"json",id:Number(c)}});d.complete(function(b){b=$.parseJSON(b.responseText);if(b.status==="success"){alert("删除成功");var a=$("#district-select").dropdown("get value");districtSelect(a[0])}else{alert("删除失败\n\n错误: "+b.error_info)}})}}function onBasicCheck(b){if(b.name===""){alert("请输入名称");return false}else{if(b.address.district===""||b.address.area===""||b.address.address===""||b.address.pos.posx===""||b.address.pos.posy===""){alert("请将地址分类下所有内容填写完整");return false}else{return true}}}function onUnitDelete(h,g){if(confirm("是否要删除户型: "+h)){var k;var f=$.ajax("http://api.panel.mzapp.info/billmanager/deleteUnit",{method:"GET",async:false,data:{protocol:"json",id:h}});f.complete(function(a){k=$.parseJSON(a.responseText);if(k.status!="success"){alert("获取失败,请重试\n\n"+k.error_info);return}});var j=$("#district-select").dropdown("get value");districtSelect(j[0]);editUnits(g)}}function onImageDelete(h,g){if(confirm("是否要删除图片: "+h)){var k;var f=$.ajax("http://api.panel.mzapp.info/billmanager/deleteImage",{method:"GET",async:false,data:{protocol:"json",id:h}});f.complete(function(a){k=$.parseJSON(a.responseText);if(k.status!="success"){alert("获取失败,请重试\n\n"+k.error_info);return}});var j=$("#district-select").dropdown("get value");districtSelect(j[0]);editImages(g)}}function onEditNewUnitClicked(){var f=Number($(".edit.units #units_num span").text())+1;var e="户型"+f;var d="<fieldset id='unit_"+f+"'><legend>"+e+"</legend>";d+="<div class='ui grid'><div class='ten wide column'>";d+="<div class='fields'><div class='five wide field'>";d+="<label>户型名称</label><input type='text' value='"+e+"' placeholder='"+e+"'>";d+="</div>";d+="<div class='five wide field'>";d+="<label>面积 / 平方米</label><input type='text' placeholder='户型面积'>";d+="</div></div>";d+="<div class='fields'>";d+="<div class='five wide field'>";d+="<label>价格 / 元/天/平方米</label><input type='text' placeholder='户型价格'>";d+="</div>";d+="<div class='five wide field'>";d+="<label>装修类型</label>";d+="<select class='ui dropdown'>";d+="<option value=''>选择装修类型</option>";d+="<option value='精装'>精装</option>";d+="<option value='简装'>简装</option>";d+="<option value='工装'>工装</option>";d+="<option value='未装修'>未装修</option>";d+="</select></div></div></div>";d+="<div class='two wide column'><div class='field'><button class='ui button' onclick='onUpload(5,"+f+")'>图片</button></div><div class='field'><button class='ui green button' onclick='onEditUnitSave("+f+")'>保存</button></div></div>";d+="<div class='four wide column'><div class='field'>";d+="<img class='ui image' src='http://7xked6.com2.z0.glb.qiniucdn.com/default_unit.png'>";d+="</div></div></div></fieldset>";$(".edit.units .content-wrapper").append($(d));$("#unit_"+f+" .ui.dropdown").dropdown();$(".edit.units #units_num span").text(f)}function onEditUnitSave(e){var f=$(".edit.units .header span").text();var g=new GetUnitData(e,f);if(g.id===undefined){alert("户型ID获取失败,请重试");return}if(g.decoration===undefined){alert("请选择装修类型");return}var h=$.ajax("http://api.panel.mzapp.info/billmanager/unitsave/?protocol=json",{method:"POST",async:false,data:{data:g}});h.complete(function(b){b=$.parseJSON(b.responseText);if(b.status==="success"){alert("保存成功 现在你可以在 '户型管理' 中看到新户型\n\n户型ID: "+b.data.id+"\n户型名字: "+b.data.name);var a=$("#district-select").dropdown("get value");districtSelect(a[0]);editUnits(f)}else{alert("保存失败\n\n错误: "+b.error_info)}})}function GetUnitData(c,d){this.id=getUnitID(d);this.bid=d;this.name=$($("#unit_"+c).children()[1].children[0].children[0].children[0]).children("input").val();this.size=$($("#unit_"+c).children()[1].children[0].children[0].children[1]).children("input").val();this.price=$($("#unit_"+c).children()[1].children[0].children[1].children[0]).children("input").val();this.decoration=$("#unit_"+c).find(".item.active.selected").attr("data-value");this.image=$("#unit_"+c).find("img").attr("src")}function getUnitID(e){var d;var f=$.ajax("http://api.panel.mzapp.info/billmanager/unitid/",{method:"GET",async:false,data:{protocol:"json",bid:e}});f.complete(function(a){a=$.parseJSON(a.responseText);if(a.status=="failed"){alert("获取户型ID失败")}else{d=a.data.id}});return d}function onEditNewImageClicked(){var g=Number($(".edit.images #images_num span").text())+1;var f="图片"+g;var e=$(".edit.images .content-wrapper").html();var h="<div class='field' id='image_"+g+"'>";h+="<div class='ui action input'>";h+="<input type='text' placeholder='图片名称' value='"+f+"'>";h+="<button class='ui teal right labeled icon button' onclick='onUpload(6,"+g+")'><i class='upload icon'></i> 上传</button>";h+="</div>";h+="<img class='ui medium image' src='http://img.static.mzapp.info/default_unit.png'>";h+="</div>";if((g-1)%4===0){h="<div class='fields'>"+h}else{if(g%4===0){e=e.substr(0,e.length-6);h+="</div>"}else{e=e.substr(0,e.length-6)}}h+="</div>";h=e+h;$(".edit.images #images_num span").text(g);$(".edit.images .content-wrapper").html(h)}function clearEdit(){$(".edit.units .content-wrapper").html("");$(".edit.units .header span").text("");$(".edit.images .header span").text("");$(".edit.images .content-wrapper").html("");$(".edit.units").hide();$(".edit.images").hide()}function onEditMainImageSave(e){var f=$($(".edit.images h5.header span")[0]).text();var d=$.ajax("http://api.panel.mzapp.info/billmanager/newMainImage/?protocol=json",{method:"POST",async:false,data:{id:f,url:e}});d.complete(function(a){a=$.parseJSON(a.responseText);if(a.status!=="success"){alert("保存失败")}else{$(".edit.images #main-image img").attr("src",e);$(".edit.images #main-image input").val(e);alert("主图更新成功")}})}function onEditNewImageSave(k,f){var g=$($(".edit.images h5.header span")[1]).text();var h=$(".edit.images #image_"+f+" input").val();var j=$.ajax("http://api.panel.mzapp.info/billmanager/newImageSave/?protocol=json",{method:"POST",async:false,data:{id:g,url:k,name:h}});j.complete(function(c){c=$.parseJSON(c.responseText);if(c.status!=="success"){alert("保存失败")}else{var b=c.data;alert("图片更新成功\n\n图片ID: "+b.iid+"\n图片名: "+b.name+"\n房源ID: "+b.bid);var a=$("#district-select").dropdown("get value");districtSelect(a[0]);editImages(b.bid)}})};