$(function(){$("#select-district .ui.dropdown").dropdown();districtSelect(0)});function districtSelect(c){clearEdit();var d=getList(c);var a=d.num;$(".table#list tbody").html("");for(var b=0;b<a;b++){displayList(d.data[b])}$("#bill_manager #list_num span").text(a)}function getList(b){var c;var a=$.ajax("http://api.panel.mzapp.info/billmanager/billlist/",{method:"GET",async:false,data:{protocol:"json",district:b}});a.complete(function(d){c=$.parseJSON(d.responseText);if(c.status!="success"){alert("获取失败,请重试\n\n"+c.error_info);return}});return c.data}function displayList(a){a=new BuildingData(a);var b="<tr id='"+a.id+"'>";b+="<td>"+a.id+"</td><td>"+a.name+"</td><td>"+a.dadd+"</td>";b+="<td>"+a.price+"</td><td>"+a.size+"</td><td>"+a.units_num+"</td><td>"+a.images_num+"</td>";b+="<td><div class='ui teal small buttons preview'><div class='ui button primary'>查看</div>";b+="<div class='ui floating dropdown icon button'>";b+="<i class='dropdown icon'></i><div class='menu'>";b+="<div class='item detail' data-value='preview-detail'>详情页</div><div class='ui divider'></div><div class='item main-image' data-value='preview-main-image'>主图</div><div class='item units' data-value='preview-units'>户型</div><div class='item images' data-value='preview-images'>其他图片</div>";b+="</div></div></div></td>";b+="<td><div class='ui red small buttons edit'><div class='ui button primary'>修改</div>";b+="<div class='ui floating dropdown icon button'>";b+="<i class='dropdown icon'></i><div class='menu'>";b+="<div class='item basic' data-value='edit-basic'>编辑房源</div><div class='item units' data-value='edit-units'>编辑户型</div><div class='item images' data-value='edit-images'>编辑图片</div><div class='divider'></div><div class='item remove' data-value='edit-remove'>删除</div>";b+="</div></div></div></td></tr>";$(".table#list tbody").append(b);activeDrop(a.id)}function BuildingData(a){this.id=a.dog_id;this.name=a.dog_name;this.district=a.dog_district;this.area=a.dog_area;this.add=a.dog_add;this.dadd=a.dog_district+"-"+a.dog_area+"-"+a.dog_add;this.size=a.dog_size.split("|").join("-");this.price=a.dog_price.split("|").join("-");this.image=a.dog_pic;this.units_num=a.units_num;this.images_num=a.images_num;this.metro=a.dog_metro.split("|");this.pos=a.dog_pos.split("|");this.description=a.dog_description}function UnitData(a){this.id=a.unit_id;this.name=a.unit_name;this.size=a.unit_size;this.price=a.unit_price;this.image=a.unit_pic;this.decoration=a.unit_deco}function ImageData(a){this.id=a.image_id;this.name=a.image_name;this.url=a.image_url;this.avaliable=a.image_avaliable}function NewBasicData(){this.id=$(".edit.edit-basic .header span").text();this.name=$(".edit.edit-basic .form #basic input").val();this.extract={metro:{line_1:$($("#metro .checkbox")[0]).checkbox("is checked"),line_2:$($("#metro .checkbox")[1]).checkbox("is checked"),line_4:$($("#metro .checkbox")[2]).checkbox("is checked"),line_5:$($("#metro .checkbox")[3]).checkbox("is checked"),line_6:$($("#metro .checkbox")[4]).checkbox("is checked")},description:$("#description textarea").val()};this.address={district:$("#district").val(),area:$("#area").val(),address:$("#add").val(),pos:{posx:$("#posx").val(),posy:$("#posy").val()}}}function activeDrop(a){$("#"+a+" .preview .ui.dropdown").dropdown({onChange:function(b){switch(b){case"preview-detail":previewDetail(a);break;case"preview-main-image":previewImage(a);break;case"preview-units":previewUnits(a);break;case"preview-images":previewImages(a);break}}});$("#"+a+" .edit .ui.dropdown").dropdown({onChange:function(b){switch(b){case"edit-basic":editBasic(a);break;case"edit-main-image":editMainImage(a);break;case"edit-units":editUnits(a);break;case"edit-images":editImages(a);break;case"edit-remove":editRemove(a);break}}})}function previewDetail(b){var a="http://mizhi.pub/detail?id="+b;window.open(a)}function previewImage(d){var c;var b=$.ajax("http://api.panel.mzapp.info/billmanager/getImage",{method:"GET",async:false,data:{protocol:"json",id:d}});b.complete(function(e){c=$.parseJSON(e.responseText);if(c.status!="success"){alert("获取失败,请重试\n\n"+c.error_info);return}else{c=c.data}});var a=c.url;$(".ui.modal.preview.main-image .header span").text(d);if(String(d).length==12){$(".ui.modal.preview.main-image .header span").append(" 户型图片")}else{$(".ui.modal.preview.main-image .header span").append(" 房源主图")}$(".ui.modal.preview.main-image img").attr("src",a);$(".ui.modal.preview.main-image").modal("show")}function previewUnits(f){var d;var c=$.ajax("http://api.panel.mzapp.info/billmanager/getUnits",{method:"GET",async:false,data:{protocol:"json",id:f}});c.complete(function(g){d=$.parseJSON(g.responseText);if(d.status!="success"){alert("获取失败,请重试\n\n"+d.error_info);return}else{d=d.data}});$(".ui.modal.preview.units .content table tbody").html("");for(var a=0;a<d.length;a++){var b=new UnitData(d[a]);var e="<tr id='"+b.id+"'>";e+="<td>"+b.id+"</td><td>"+b.name+"</td><td>"+b.size+"</td><td>"+b.price+"</td><td>"+b.decoration+"</td>";e+="<td><div class='ui small button teal' onclick='previewImage("+b.id+")'>查看</div></td>";e+="</tr>";$(".ui.modal.preview.units .content table tbody").append(e)}$(".ui.modal.preview.units .content table thead tr th span").text(d.length);$(".ui.modal.preview.units header span").text(f);$(".ui.modal.preview.units").modal("show")}function previewImages(f){var c;var b=$.ajax("http://api.panel.mzapp.info/billmanager/getImages",{method:"GET",async:false,data:{protocol:"json",id:f}});b.complete(function(g){c=$.parseJSON(g.responseText);if(c.status!="success"){alert("获取失败,请重试\n\n"+c.error_info);return}else{c=c.data}});$(".ui.modal.preview.images .content .images").html("");for(var a=0;a<c.length;a++){var d=new ImageData(c[a]);var e="<div class='ui segment'>";e+="<div class='ui bottom attached label'>"+d.name+"</div>";e+="<img class='ui image' src='"+d.url+"' id='"+d.id+"'>";e+="</div>";$(".ui.modal.preview.images .content .images").append(e)}$(".ui.modal.preview.images .header span").text(f+"  图片数: "+c.length);$(".ui.modal.preview.images").modal("show")}function editBasic(c){clearEdit();var b;var a=$.ajax("http://api.panel.mzapp.info/billmanager/getBasic",{method:"GET",async:false,data:{protocol:"json",id:c}});a.complete(function(f){b=$.parseJSON(f.responseText);if(b.status!="success"){alert("获取失败,请重试\n\n"+b.error_info);return}else{b=b.data;b=new BuildingData(b);$(".ui.modal.edit.edit-basic .header span").text(b.id);$(".ui.modal.edit.edit-basic #basic input").val(b.name);(b.metro[0]=="true")?$($("#metro .checkbox")[0]).checkbox("set checked"):$($("#metro .checkbox")[0]).checkbox();(b.metro[1]=="true")?$($("#metro .checkbox")[1]).checkbox("set checked"):$($("#metro .checkbox")[0]).checkbox();(b.metro[2]=="true")?$($("#metro .checkbox")[2]).checkbox("set checked"):$($("#metro .checkbox")[0]).checkbox();(b.metro[3]=="true")?$($("#metro .checkbox")[3]).checkbox("set checked"):$($("#metro .checkbox")[0]).checkbox();(b.metro[4]=="true")?$($("#metro .checkbox")[4]).checkbox("set checked"):$($("#metro .checkbox")[0]).checkbox();onMapLoaded(false,b.pos);var g=new AMap.Marker({map:map,position:new AMap.LngLat(b.pos[0],b.pos[1]),icon:"http://webapi.amap.com/images/0.png"});var d=[];d.push("<b>"+b.name+"</b>");d.push(b.dadd);var e=new AMap.InfoWindow({offset:new AMap.Pixel(0,-23),content:d.join("<br>")});e.open(map,g.getPosition());AMap.event.addListener(g,"click",function(h){e.open(map,g.getPosition())});$(".ui.modal.edit.edit-basic #district").val(b.district).dropdown();$(".ui.modal.edit.edit-basic #area").val(b.area).dropdown();$(".ui.modal.edit.edit-basic #add").val(b.add);$(".ui.modal.edit.edit-basic #posx").val(b.pos[0]);$(".ui.modal.edit.edit-basic #posy").val(b.pos[1]);$(".ui.modal.edit.edit-basic #description textarea").val(b.description);$(".ui.modal.edit.edit-basic").modal("setting","closable",false).modal("show").modal({onDeny:function(){$(".ui.modal.edit.edit-basic").modal("hide")},onApprove:function(){var h=new NewBasicData();if(onBasicCheck(h)){var j=$.ajax("http://api.panel.mzapp.info/billmanager/basicsave/?protocol=json",{method:"POST",async:false,data:{data:h}});j.complete(function(k){k=$.parseJSON(k.responseText);if(k.status==="success"){$(".ui.modal.edit.edit-basic").modal("hide");alert("保存成功 现在你可以在 '房源管理' 中管理房源\n\n房源ID: "+k.data.id+"\n房源名字: "+k.data.name);var l=$("#district-select").dropdown("get value");districtSelect(l[0])}else{alert("保存失败\n\n错误: "+k.error_info)}})}}})}})}function editUnits(c){clearEdit();var b;var a=$.ajax("http://api.panel.mzapp.info/billmanager/getUnits",{method:"GET",async:false,data:{protocol:"json",id:c}});a.complete(function(g){b=$.parseJSON(g.responseText);if(b.status!="success"){alert("获取失败,请重试\n\n"+b.error_info)}else{b=b.data;var e=b.length;$(".edit.units .content-wrapper").html("");for(var f=0;f<b.length;f++){var h=new UnitData(b[f]);var k=f+1;var d="户型"+k;var j="<fieldset id='"+h.id+"'><legend>"+d+"</legend>";j+="<div class='ui grid'><div class='ten wide column'>";j+="<div class='fields'><div class='five wide field'>";j+="<label>户型名称</label><input type='text' value='"+h.name+"' placeholder='"+d+"' readonly>";j+="</div>";j+="<div class='five wide field'>";j+="<label>面积 / 平方米</label><input type='text' placeholder='户型面积' value='"+h.size+"' readonly>";j+="</div></div>";j+="<div class='fields'>";j+="<div class='five wide field'>";j+="<label>价格 / 元/天/平方米</label><input type='text' placeholder='户型价格' value='"+h.price+"' readonly>";j+="</div>";j+="<div class='five wide field'>";j+="<label>装修类型</label>";j+="<input value='"+h.decoration+"' readonly></input>";j+="</div></div></div>";j+="<div class='two wide column'><button class='ui red button' onclick='onUnitDelete("+h.id+","+c+")'>删除</button></div>";j+="<div class='four wide column'><div class='field'>";j+="<img class='ui image' src='"+h.image+"'>";j+="</div></div></div></fieldset>";$(".edit.units .content-wrapper").append(j)}$(".edit.units #units_num span").text(e);$(".edit.units .header span").text(c);$(".edit.units").show();$(".ui.button.add.unit").on("click",function(l){l.preventDefault();onEditNewUnitClicked()})}})}function editImages(e){clearEdit();var d;var c=$.ajax("http://api.panel.mzapp.info/billmanager/getImages",{method:"GET",async:false,data:{protocol:"json",id:e}});c.complete(function(j){d=$.parseJSON(j.responseText);if(d.status!="success"){alert("获取失败,请重试\n\n"+d.error_info)}else{d=d.data;var g=d.length;for(i=0;i<g;i++){var k=new ImageData(d[i]);var m=i+1;var f="图片"+m;var h=$(".edit.images .content-wrapper").html();var l="<div class='field' id='"+k.id+"'>";l+="<div class='ui action input'>";l+="<input type='text' placeholder='图片名称' value='"+k.name+"' readonly>";l+="<button class='ui red button' onclick='onImageDelete("+k.id+","+e+")'>删除</button>";l+="</div>";l+="<img class='ui medium image' src='"+k.url+"'>";l+="</div>";if((m-1)%4===0){l="<div class='fields'>"+l}else{if(m%4===0){h=h.substr(0,h.length-6);l+="</div>"}else{h=h.substr(0,h.length-6)}}l+="</div>";l=h+l;$(".edit.images .content-wrapper").html(l)}$(".edit.images #images_num span").text(g);$(".edit.images .header span").text(e);$(".edit.images").show();$(".ui.button.add.images").on("click",function(n){n.preventDefault();onEditNewImageClicked()})}});var a;var b=$.ajax("http://api.panel.mzapp.info/billmanager/getMainImage",{method:"GET",async:false,data:{protocol:"json",id:e}});b.complete(function(f){a=$.parseJSON(f.responseText).data;$(".edit.images #main-image img").attr("src",a.url);$(".edit.images #main-image input").val(a.url)})}function editRemove(b){clearEdit();if(confirm("是否要删除户型: "+b)){var a=$.ajax("http://api.panel.mzapp.info/billmanager/deleteBuilding/",{method:"GET",async:false,data:{protocol:"json",id:Number(b)}});a.complete(function(c){c=$.parseJSON(c.responseText);if(c.status==="success"){alert("删除成功");var d=$("#district-select").dropdown("get value");districtSelect(d[0])}else{alert("删除失败\n\n错误: "+c.error_info)}})}}function onBasicCheck(a){if(a.name===""){alert("请输入名称");return false}else{if(a.address.district===""||a.address.area===""||a.address.address===""||a.address.pos.posx===""||a.address.pos.posy===""){alert("请将地址分类下所有内容填写完整");return false}else{return true}}}function onUnitDelete(e,a){if(confirm("是否要删除户型: "+e)){var c;var b=$.ajax("http://api.panel.mzapp.info/billmanager/deleteUnit",{method:"GET",async:false,data:{protocol:"json",id:e}});b.complete(function(f){c=$.parseJSON(f.responseText);if(c.status!="success"){alert("获取失败,请重试\n\n"+c.error_info);return}});var d=$("#district-select").dropdown("get value");districtSelect(d[0]);editUnits(a)}}function onImageDelete(e,a){if(confirm("是否要删除图片: "+e)){var c;var b=$.ajax("http://api.panel.mzapp.info/billmanager/deleteImage",{method:"GET",async:false,data:{protocol:"json",id:e}});b.complete(function(f){c=$.parseJSON(f.responseText);if(c.status!="success"){alert("获取失败,请重试\n\n"+c.error_info);return}});var d=$("#district-select").dropdown("get value");districtSelect(d[0]);editImages(a)}}function onEditNewUnitClicked(){var c=Number($(".edit.units #units_num span").text())+1;var a="户型"+c;var b="<fieldset id='unit_"+c+"'><legend>"+a+"</legend>";b+="<div class='ui grid'><div class='ten wide column'>";b+="<div class='fields'><div class='five wide field'>";b+="<label>户型名称</label><input type='text' value='"+a+"' placeholder='"+a+"'>";b+="</div>";b+="<div class='five wide field'>";b+="<label>面积 / 平方米</label><input type='text' placeholder='户型面积'>";b+="</div></div>";b+="<div class='fields'>";b+="<div class='five wide field'>";b+="<label>价格 / 元/天/平方米</label><input type='text' placeholder='户型价格'>";b+="</div>";b+="<div class='five wide field'>";b+="<label>装修类型</label>";b+="<select class='ui dropdown'>";b+="<option value=''>选择装修类型</option>";b+="<option value='精装'>精装</option>";b+="<option value='简装'>简装</option>";b+="<option value='工装'>工装</option>";b+="<option value='未装修'>未装修</option>";b+="</select></div></div></div>";b+="<div class='two wide column'><div class='field'><button class='ui button' onclick='onUpload(5,"+c+")'>图片</button></div><div class='field'><button class='ui green button' onclick='onEditUnitSave("+c+")'>保存</button></div></div>";b+="<div class='four wide column'><div class='field'>";b+="<img class='ui image' src='http://7xked6.com2.z0.glb.qiniucdn.com/default_unit.png'>";b+="</div></div></div></fieldset>";$(".edit.units .content-wrapper").append($(b));$("#unit_"+c+" .ui.dropdown").dropdown();$(".edit.units #units_num span").text(c)}function onEditUnitSave(b){var a=$(".edit.units .header span").text();var d=new GetUnitData(b,a);if(d.id===undefined){alert("户型ID获取失败,请重试");return}if(d.decoration===undefined){alert("请选择装修类型");return}var c=$.ajax("http://api.panel.mzapp.info/billmanager/unitsave/?protocol=json",{method:"POST",async:false,data:{data:d}});c.complete(function(e){e=$.parseJSON(e.responseText);if(e.status==="success"){alert("保存成功 现在你可以在 '户型管理' 中看到新户型\n\n户型ID: "+e.data.id+"\n户型名字: "+e.data.name);var f=$("#district-select").dropdown("get value");districtSelect(f[0]);editUnits(a)}else{alert("保存失败\n\n错误: "+e.error_info)}})}function GetUnitData(b,a){this.id=getUnitID(a);this.bid=a;this.name=$($("#unit_"+b).children()[1].children[0].children[0].children[0]).children("input").val();this.size=$($("#unit_"+b).children()[1].children[0].children[0].children[1]).children("input").val();this.price=$($("#unit_"+b).children()[1].children[0].children[1].children[0]).children("input").val();this.decoration=$("#unit_"+b).find(".item.active.selected").attr("data-value");this.image=$("#unit_"+b).find("img").attr("src")}function getUnitID(a){var b;var c=$.ajax("http://api.panel.mzapp.info/billmanager/unitid/",{method:"GET",async:false,data:{protocol:"json",bid:a}});c.complete(function(d){d=$.parseJSON(d.responseText);if(d.status=="failed"){alert("获取户型ID失败")}else{b=d.data.id}});return b}function onEditNewImageClicked(){var d=Number($(".edit.images #images_num span").text())+1;var a="图片"+d;var b=$(".edit.images .content-wrapper").html();var c="<div class='field' id='image_"+d+"'>";c+="<div class='ui action input'>";c+="<input type='text' placeholder='图片名称' value='"+a+"'>";c+="<button class='ui teal right labeled icon button' onclick='onUpload(6,"+d+")'><i class='upload icon'></i> 上传</button>";c+="</div>";c+="<img class='ui medium image' src='http://img.static.mzapp.info/default_unit.png'>";c+="</div>";if((d-1)%4===0){c="<div class='fields'>"+c}else{if(d%4===0){b=b.substr(0,b.length-6);c+="</div>"}else{b=b.substr(0,b.length-6)}}c+="</div>";c=b+c;$(".edit.images #images_num span").text(d);$(".edit.images .content-wrapper").html(c)}function clearEdit(){$(".edit.units .content-wrapper").html("");$(".edit.units .header span").text("");$(".edit.images .header span").text("");$(".edit.images .content-wrapper").html("");$(".edit.units").hide();$(".edit.images").hide()}function onEditMainImageSave(a){var c=$($(".edit.images h5.header span")[0]).text();var b=$.ajax("http://api.panel.mzapp.info/billmanager/newMainImage/?protocol=json",{method:"POST",async:false,data:{id:c,url:a}});b.complete(function(d){d=$.parseJSON(d.responseText);if(d.status!=="success"){alert("保存失败")}else{$(".edit.images #main-image img").attr("src",a);$(".edit.images #main-image input").val(a);alert("主图更新成功")}})}function onEditNewImageSave(c,b){var a=$($(".edit.images h5.header span")[1]).text();var e=$(".edit.images #image_"+b+" input").val();var d=$.ajax("http://api.panel.mzapp.info/billmanager/newImageSave/?protocol=json",{method:"POST",async:false,data:{id:a,url:c,name:e}});d.complete(function(f){f=$.parseJSON(f.responseText);if(f.status!=="success"){alert("保存失败")}else{var g=f.data;alert("图片更新成功\n\n图片ID: "+g.iid+"\n图片名: "+g.name+"\n房源ID: "+g.bid);var h=$("#district-select").dropdown("get value");districtSelect(h[0]);editImages(g.bid)}})};