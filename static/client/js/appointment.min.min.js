$(function(){$("#appoint_loading").css("display","block");$("#appoint_loading .status.loading").css("display","block");var b=$.ajax(location.origin+"/api/appointment/logined",{method:"GET",data:{protocol:"json"}});b.complete(function(a){var d=$.parseJSON(a.responseText).overview;if(d.user_status!=="success"){setTimeout(function(){notLogined()},500)}else{setTimeout(function(){logined(d.user_id)},500)}})});function logined(b){$("#appoint_loading .status.loading").hide();$("#appoint_loading .status.success").show();setTimeout(function(){loginSuccess(b)},500)}function notLogined(){$("#appoint_loading .status.loading").hide();$("#appoint_loading .status.failed").show();setTimeout(function(){$("#appoint_loading").hide();$("#appoint_id").show()},500)}var user={phoneNum:"",varifyCode:""};function onUserInput(f){$("#appoint_id .button").removeClass("loading");$("#appoint_id .button").text("获取验证码");$(".ui.message").removeClass("visible");$(".ui.error.phone.message .header").text("手机号不合法");if(f.length===11){if(phoneNumCheck(f)){user.phoneNum=f;$("#appoint_id .button").addClass("loading");$("#phoneNum").attr("readonly","readonly");var d=verifySend(f);if(d.status==="success"){$("#verify-code").show();$("#appoint_id .button").removeClass("loading");$("#appoint_id .button").removeClass("disabled");$("#appoint_id .button").text("重新获取");user.varifyCode=d.overview.varifyCode;$("#appoint_id input #phoneNum").removeAttr("readonly");var e=new SetCountDown();e.start()}else{$(".ui.error.phone.message .header").text(d.error_info);$(".ui.error.phone.message").addClass("visible");$("#phoneNum").removeAttr("readonly");$("#appoint_id .button").removeClass("loading");$("#appoint_id .button").text("获取验证码")}}else{$(".ui.error.phone.message .header").text("手机号不合法");$(".ui.error.phone.message").addClass("visible")}}else{$("#verify-code").hide();$("#appoint_id .button").removeClass("loading");$("#appoint_id .button").text("获取验证码");$(".ui.message").removeClass("visible");$(".ui.error.phone.message .header").text("手机号不合法")}}function phoneNumCheck(b){return(/^13\d{9}$/g.test(b)||(/^15\d{9}$/g.test(b))||(/^18\d{9}$/g.test(b)))}function SetCountDown(g){var f=90;var h=f;var e;this.currentTime=h;this.start=function(){e=setInterval(function(){h--;if(h<=0){clearInterval(e);$("#appoint_id .button").removeClass("disabled");$("#appoint_id input").removeAttr("readonly");$("#appoint_id .button").removeClass("loading")}$("#verify-code .label span").text(h)},1000);$("#appoint_id .button").text("重新获取");if(!$("#appoint_id .button").hasClass("disabled")){$("#appoint_id .button").addClass("disabled")}$("#appoint_id .button").removeClass("loading")};this.id=this.stop=function(){clearInterval(e);$("#appoint_id .button").removeClass("disabled");$("#appoint_id input").removeAttr("readonly");$("#appoint_id .button").removeClass("loading")}}function onVerifyCodeInput(b){$("#appoint_id .button").removeClass("loading");$(".ui.message").removeClass("visible");if(b.length===6){$("#appoint_id .button").addClass("loading");$("#appoint_id input").attr("readonly","readonly");if($("#phoneNum").val()==user.phoneNum&&b==user.varifyCode){onLogin(user.phoneNum)}else{$(".ui.message.varify").addClass("visible");$("#appoint_id input").removeAttr("readonly");$("#appoint_id .button").removeClass("loading")}}else{}}function onLogin(d){$("#appoint_id .button").addClass("disabled");$("#appoint_id .button").addClass("loading");$("#appoint_id input").attr("readonly","readonly");var c=$.ajax("http://api.mzapp.info/appointuser/userexisted",{method:"GET",async:false,data:{protocol:"json",phone:d}});c.complete(function(b){var a=$.parseJSON(b.responseText).overview;if(a.status==="success"){userExisted(a.uid)}else{userNotExisted(d)}})}function loginSuccess(b){$("#appoint_loading").hide();$("#appoint_id").hide();$("#appoint_info").show();setAppointmentUserInfo(b);$("#appoint_info .save.button").click(function(a){$(a.target).addClass("loading disabled");saveAppointment();console.log($(a.target));$(a.target).removeClass("loading");$(a.target).removeClass("disabled");$(a.target).removeAttr("disabled")})}function saveAppointment(){var c=getAppointmentData();var d=sendAppointment(c);if(d.status==="success"){alert("预约成功");alreadyAppointed()}else{appointmentFailed(d.overview.id);alert("预约失败,请重试: "+d.error_info)}}function getAppointmentData(){return{bid:getBID(),uid:$("#appoint_info .field.appoint.id label span").text(),uphone:$($("#appoint_info .field.appoint.contacts label span")[0]).text(),uaddress:$("#appoint_info .field.appoint.address label span").text(),ucontacts:{uemail:$($("#appoint_info .field.appoint.contacts label span")[1]).text(),uphone:$($("#appoint_info .field.appoint.contacts label span")[2]).text()},time:{date:getSelectedDate(),time:$("#time-select").dropdown("get text")}}}function getSelectedDate(){var i=$("#data-select").dropdown("get value");i=i.substr(0,(i.length-1));var f=new Date();var j=f.getDate();var h;var g=f.getFullYear()+".";if(i<j){h=f.getMonth()+2}else{h=f.getMonth()+1}g+=(h.length===2)?h:"0"+h;g+="."+((i.length===2)?i:"0"+i);return g}function sendAppointment(f){var e;var d=$.ajax("http://api.mzapp.info/appointment/saveAppointment?protocol=json",{method:"POST",async:false,data:f});d.complete(function(a){e=$.parseJSON(a.responseText)});return e}function appointmentFailed(c){var d=$.ajax("http://api.mzapp.info/appointment/appointmentFailed",{method:"GET",async:false,data:{protocol:"json",id:c}});d.complete(function(){});return true}function getAppointStatus(d){var e;var f=$.ajax("http://api.mzapp.info/appointment/alreadyAppointed",{method:"GET",async:false,data:{protocol:"json",uid:d,bid:getBID()}});f.complete(function(a){e=$.parseJSON(a.responseText)});if(e.status==="success"){e=(e.overview.apointed==="yes")}else{e=false}if(e){alreadyAppointed()}return e}function alreadyAppointed(){$("#appoint_info .field").hide();$("#appoint_info .field.appoint.appointed").show()}function appoineEdit(){$($("#appointment-edit input")[1]).val($($("#appoint_info .field.appoint.contacts label span")[2]).text());$($("#appointment-edit input")[0]).val($("#appoint_info .field.appoint.address label span").text());$("#appointment-edit").modal("setting","closable",false).modal("show");$("#appointment-edit .actions .primary.button").click(function(){$($("#appoint_info .field.appoint.contacts label span")[2]).text($($("#appointment-edit input")[1]).val());$("#appoint_info .field.appoint.address label span").text($($("#appointment-edit input")[0]).val());$("#appointment-edit").modal("hide")});$("#appointment-edit .actions .cancel.button").click(function(){$("#appointment-edit").modal("hide")})};