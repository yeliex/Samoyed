$(function(){$("#appoint_loading").css("display","block");$("#appoint_loading .status.loading").css("display","block");var a=$.ajax(location.origin+"/api/appointment/logined",{method:"GET",data:{protocol:"json"}});a.complete(function(b){var c=$.parseJSON(b.responseText).overview;if(c.user_status!=="success"){setTimeout(function(){notLogined()},500)}else{setTimeout(function(){logined(c.user_id)},500)}})});function logined(a){$("#appoint_loading .status.loading").hide();$("#appoint_loading .status.success").show();setTimeout(function(){loginSuccess(a)},500)}function notLogined(){$("#appoint_loading .status.loading").hide();$("#appoint_loading .status.failed").show();setTimeout(function(){$("#appoint_loading").hide();$("#appoint_id").show()},500)}var user={phoneNum:"",varifyCode:""};function onUserInput(c){$("#appoint_id .button").removeClass("loading");$("#appoint_id .button").text("获取验证码");$(".ui.message").removeClass("visible");$(".ui.error.phone.message .header").text("手机号不合法");if(c.length===11){if(phoneNumCheck(c)){user.phoneNum=c;$("#appoint_id .button").addClass("loading");$("#phoneNum").attr("readonly","readonly");var b=verifySend(c);if(b.status==="success"){$("#verify-code").show();$("#appoint_id .button").removeClass("loading");$("#appoint_id .button").removeClass("disabled");$("#appoint_id .button").text("重新获取");user.varifyCode=b.overview.varifyCode;$("#appoint_id input #phoneNum").removeAttr("readonly");var a=new SetCountDown();a.start()}else{$(".ui.error.phone.message .header").text(b.error_info);$(".ui.error.phone.message").addClass("visible");$("#phoneNum").removeAttr("readonly");$("#appoint_id .button").removeClass("loading");$("#appoint_id .button").text("获取验证码")}}else{$(".ui.error.phone.message .header").text("手机号不合法");$(".ui.error.phone.message").addClass("visible")}}else{$("#verify-code").hide();$("#appoint_id .button").removeClass("loading");$("#appoint_id .button").text("获取验证码");$(".ui.message").removeClass("visible");$(".ui.error.phone.message .header").text("手机号不合法")}}function phoneNumCheck(a){return(/^13\d{9}$/g.test(a)||(/^15\d{9}$/g.test(a))||(/^18\d{9}$/g.test(a)))}function SetCountDown(d){var a=90;var c=a;var b;this.currentTime=c;this.start=function(){b=setInterval(function(){c--;if(c<=0){clearInterval(b);$("#appoint_id .button").removeClass("disabled");$("#appoint_id input").removeAttr("readonly");$("#appoint_id .button").removeClass("loading")}$("#verify-code .label span").text(c)},1000);$("#appoint_id .button").text("重新获取");if(!$("#appoint_id .button").hasClass("disabled")){$("#appoint_id .button").addClass("disabled")}$("#appoint_id .button").removeClass("loading")};this.id=this.stop=function(){clearInterval(b);$("#appoint_id .button").removeClass("disabled");$("#appoint_id input").removeAttr("readonly");$("#appoint_id .button").removeClass("loading")}}function onVerifyCodeInput(a){$("#appoint_id .button").removeClass("loading");$(".ui.message").removeClass("visible");if(a.length===6){$("#appoint_id .button").addClass("loading");$("#appoint_id input").attr("readonly","readonly");if($("#phoneNum").val()==user.phoneNum&&a==user.varifyCode){onLogin(user.phoneNum)}else{$(".ui.message.varify").addClass("visible");$("#appoint_id input").removeAttr("readonly");$("#appoint_id .button").removeClass("loading")}}else{}}function onLogin(a){$("#appoint_id .button").addClass("disabled");$("#appoint_id .button").addClass("loading");$("#appoint_id input").attr("readonly","readonly");var b=$.ajax("http://api.mzapp.info/appointuser/userexisted",{method:"GET",async:false,data:{protocol:"json",phone:a}});b.complete(function(c){var d=$.parseJSON(c.responseText).overview;if(d.status==="success"){userExisted(d.uid)}else{userNotExisted(a)}})}function loginSuccess(a){$("#appoint_loading").hide();$("#appoint_id").hide();$("#appoint_info").show();setAppointmentUserInfo(a);$("#appoint_info .save.button").click(function(b){$(b.target).addClass("loading disabled");saveAppointment();console.log($(b.target));$(b.target).removeClass("loading");$(b.target).removeClass("disabled");$(b.target).removeAttr("disabled")})}function saveAppointment(){var b=getAppointmentData();var a=sendAppointment(b);if(a.status==="success"){alert("预约成功");alreadyAppointed()}else{appointmentFailed(a.overview.id);alert("预约失败,请重试: "+a.error_info)}}function getAppointmentData(){return{bid:getBID(),uid:$("#appoint_info .field.appoint.id label span").text(),uphone:$($("#appoint_info .field.appoint.contacts label span")[0]).text(),uaddress:$("#appoint_info .field.appoint.address label span").text(),ucontacts:{uemail:$($("#appoint_info .field.appoint.contacts label span")[1]).text(),uphone:$($("#appoint_info .field.appoint.contacts label span")[2]).text()},time:{date:getSelectedDate(),time:$("#time-select").dropdown("get text")}}}function getSelectedDate(){var d=$("#data-select").dropdown("get value");d=d.substr(0,(d.length-1));var b=new Date();var c=b.getDate();var e;var a=b.getFullYear()+".";if(d<c){e=b.getMonth()+2}else{e=b.getMonth()+1}a+=(e.length===2)?e:"0"+e;a+="."+((d.length===2)?d:"0"+d);return a}function sendAppointment(c){var a;var b=$.ajax("http://api.mzapp.info/appointment/saveAppointment?protocol=json",{method:"POST",async:false,data:c});b.complete(function(d){a=$.parseJSON(d.responseText)});return a}function appointmentFailed(b){var a=$.ajax("http://api.mzapp.info/appointment/appointmentFailed",{method:"GET",async:false,data:{protocol:"json",id:b}});a.complete(function(){});return true}function getAppointStatus(b){var a;var c=$.ajax("http://api.mzapp.info/appointment/alreadyAppointed",{method:"GET",async:false,data:{protocol:"json",uid:b,bid:getBID()}});c.complete(function(d){a=$.parseJSON(d.responseText)});if(a.status==="success"){a=(a.overview.apointed==="yes")}else{a=false}if(a){alreadyAppointed()}return a}function alreadyAppointed(){$("#appoint_info .field").hide();$("#appoint_info .field.appoint.appointed").show()}function appoineEdit(){$($("#appointment-edit input")[1]).val($($("#appoint_info .field.appoint.contacts label span")[2]).text());$($("#appointment-edit input")[0]).val($("#appoint_info .field.appoint.address label span").text());$("#appointment-edit").modal("setting","closable",false).modal("show");$("#appointment-edit .actions .primary.button").click(function(){$($("#appoint_info .field.appoint.contacts label span")[2]).text($($("#appointment-edit input")[1]).val());$("#appoint_info .field.appoint.address label span").text($($("#appointment-edit input")[0]).val());$("#appointment-edit").modal("hide")});$("#appointment-edit .actions .cancel.button").click(function(){$("#appointment-edit").modal("hide")})};