/*!
 * # Semantic UI x.x - API
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Copyright 2015 Contributors
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */
;(function(h,e,f,g){h.api=h.fn.api=function(a){var c=h.isFunction(this)?h(e):h(this),o=c.selector||"",q=new Date().getTime(),d=[],n=arguments[0],r=(typeof n=="string"),b=[].slice.call(arguments,1),p;c.each(function(){var K=(h.isPlainObject(a))?h.extend(true,{},h.fn.api.settings,a):h.extend({},h.fn.api.settings),k=K.namespace,l=K.metadata,O=K.selector,Q=K.error,R=K.className,T="."+k,j="module-"+k,L=h(this),J=L.closest(O.form),i=(K.stateContext)?h(K.stateContext):L,H,P,M,m,N,U=this,S=i[0],I=L.data(j),V;V={initialize:function(){if(!r){V.bind.events()}V.instantiate()},instantiate:function(){V.verbose("Storing instance of module",V);I=V;L.data(j,I)},destroy:function(){V.verbose("Destroying previous module for",U);L.removeData(j).off(T)},bind:{events:function(){var s=V.get.event();if(s){V.verbose("Attaching API events to element",s);L.on(s+T,V.event.trigger)}else{if(K.on=="now"){V.debug("Querying API now",s);V.query()}}}},read:{cachedResponse:function(t){var u;if(e.Storage===g){V.error(Q.noStorage);return}u=sessionStorage.getItem(t);V.debug("Using cached response",t,u);if(u!==g){try{u=JSON.parse(u)}catch(s){}return u}return false}},write:{cachedResponse:function(s,t){if(t&&t===""){V.debug("Response empty, not caching",t);return}if(e.Storage===g){V.error(Q.noStorage);return}if(h.isPlainObject(t)){t=JSON.stringify(t)}sessionStorage.setItem(s,t);V.verbose("Storing cached response for url",s,t)}},query:function(){if(V.is.disabled()){V.debug("Element is disabled API request aborted");return}if(V.is.loading()){if(K.interruptRequests){V.debug("Interrupting previous request");V.abort()}else{V.debug("Cancelling request, previous request is still pending");return}}if(K.defaultData){h.extend(true,K.urlData,V.get.defaultData())}if(K.serializeForm){K.data=V.add.formData(K.data)}P=V.get.settings();if(P===false){V.cancelled=true;V.error(Q.beforeSend);return}else{V.cancelled=false}M=V.get.templatedURL();if(!M&&!V.is.mocked()){V.error(Q.missingURL);return}M=V.add.urlData(M);if(!M&&!V.is.mocked()){return}H=h.extend(true,{},K,{type:K.method||K.type,data:m,url:K.base+M,beforeSend:K.beforeXHR,success:function(){},failure:function(){},complete:function(){}});V.debug("Querying URL",H.url);V.verbose("Using AJAX settings",H);if(K.cache==="local"&&V.read.cachedResponse(M)){V.debug("Response returned from local cache");V.request=V.create.request();V.request.resolveWith(S,[V.read.cachedResponse(M)]);return}if(!K.throttle){V.debug("Sending request",m,H.method);V.send.request()}else{if(!K.throttleFirstRequest&&!V.timer){V.debug("Sending request",m,H.method);V.send.request();V.timer=setTimeout(function(){},K.throttle)}else{V.debug("Throttling request",K.throttle);clearTimeout(V.timer);V.timer=setTimeout(function(){if(V.timer){delete V.timer}V.debug("Sending throttled request",m,H.method);V.send.request()},K.throttle)}}},is:{disabled:function(){return(L.filter(O.disabled).length>0)},form:function(){return L.is("form")},mocked:function(){return(K.mockResponse||K.mockResponseAsync)},input:function(){return L.is("input")},loading:function(){return(V.request&&V.request.state()=="pending")},abortedRequest:function(s){if(s&&s.readyState!==g&&s.readyState===0){V.verbose("XHR request determined to be aborted");return true}else{V.verbose("XHR request was not aborted");return false}},validResponse:function(s){if(K.dataType!=="json"||!h.isFunction(K.successTest)){V.verbose("Response is not JSON, skipping validation",K.successTest,s);return true}V.debug("Checking JSON returned success",K.successTest,s);if(K.successTest(s)){V.debug("Response passed success test",s);return true}else{V.debug("Response failed success test",s);return false}}},was:{cancelled:function(){return(V.cancelled||false)},succesful:function(){return(V.request&&V.request.state()=="resolved")},failure:function(){return(V.request&&V.request.state()=="rejected")},complete:function(){return(V.request&&(V.request.state()=="resolved"||V.request.state()=="rejected"))}},add:{urlData:function(u,v){var t,s;if(u){t=u.match(K.regExp.required);s=u.match(K.regExp.optional);v=v||K.urlData;if(t){V.debug("Looking for required URL variables",t);h.each(t,function(z,y){var w=(y.indexOf("$")!==-1)?y.substr(2,y.length-3):y.substr(1,y.length-2),x=(h.isPlainObject(v)&&v[w]!==g)?v[w]:(L.data(w)!==g)?L.data(w):(i.data(w)!==g)?i.data(w):v[w];if(x===g){V.error(Q.requiredParameter,w,u);u=false;return false}else{V.verbose("Found required variable",w,x);u=u.replace(y,x)}})}if(s){V.debug("Looking for optional URL variables",t);h.each(s,function(z,y){var w=(y.indexOf("$")!==-1)?y.substr(3,y.length-4):y.substr(2,y.length-3),x=(h.isPlainObject(v)&&v[w]!==g)?v[w]:(L.data(w)!==g)?L.data(w):(i.data(w)!==g)?i.data(w):v[w];if(x!==g){V.verbose("Optional variable Found",w,x);u=u.replace(y,x)}else{V.verbose("Optional variable not found",w);if(u.indexOf("/"+y)!==-1){u=u.replace("/"+y,"")}else{u=u.replace(y,"")}}})}}return u},formData:function(t){var v=(h.fn.serializeObject!==g),s=(v)?J.serializeObject():J.serialize(),u;t=t||K.data;u=h.isPlainObject(t);if(u){if(v){V.debug("Extending existing data with form data",t,s);t=h.extend(true,{},t,s)}else{V.error(Q.missingSerialize);V.debug("Cant extend data. Replacing data with form data",t,s);t=s}}else{V.debug("Adding form data",s);t=s}return t}},send:{request:function(){V.set.loading();V.request=V.create.request();if(V.is.mocked()){V.mockedXHR=V.create.mockedXHR()}else{V.xhr=V.create.xhr()}K.onRequest.call(S,V.request,V.xhr)}},event:{trigger:function(s){V.query();if(s.type=="submit"||s.type=="click"){s.preventDefault()}},xhr:{always:function(){},done:function(v,x,s){var u=this,w=(new Date().getTime()-N),y=(K.loadingDuration-w),t=(h.isFunction(K.onResponse))?K.onResponse.call(u,h.extend(true,{},v)):false;y=(y>0)?y:0;if(t){V.debug("Modified API response in onResponse callback",K.onResponse,t,v);v=t}if(y>0){V.debug("Response completed early delaying state change by",y)}setTimeout(function(){if(V.is.validResponse(v)){V.request.resolveWith(u,[v])}else{V.request.rejectWith(u,[s,"invalid"])}},y)},fail:function(s,w,u){var t=this,v=(new Date().getTime()-N),x=(K.loadingDuration-v);x=(x>0)?x:0;if(x>0){V.debug("Response completed early delaying state change by",x)}setTimeout(function(){if(V.is.abortedRequest(s)){V.request.rejectWith(t,[s,"aborted",u])}else{V.request.rejectWith(t,[s,"error",w,u])}},x)}},request:{complete:function(s){V.remove.loading();K.onComplete.call(S,s,L)},done:function(s){V.debug("Successful API Response",s);if(K.cache==="local"&&M){V.write.cachedResponse(M,s);V.debug("Saving server response locally",V.cache)}K.onSuccess.call(S,s,L)},fail:function(s,w,t){var v=h.isPlainObject(s)?(s.responseText):false,u=(h.isPlainObject(v)&&v.error!==g)?v.error:(K.error[w]!==g)?K.error[w]:t;if(w=="aborted"){V.debug("XHR Aborted (Most likely caused by page navigation or CORS Policy)",w,t);K.onAbort.call(S,w,L)}else{if(w=="invalid"){V.debug("JSON did not pass success test. A server-side error has most likely occurred",v)}else{if(w=="error"){if(s!==g){V.debug("XHR produced a server error",w,t);if(s.status!=200&&t!==g&&t!==""){V.error(Q.statusMessage+t,H.url)}K.onError.call(S,u,L)}}}}if(K.errorDuration&&w!=="aborted"){V.debug("Adding error state");V.set.error();setTimeout(V.remove.error,K.errorDuration)}V.debug("API Request failed",u,s);K.onFailure.call(S,v,L)}}},create:{request:function(){return h.Deferred().always(V.event.request.complete).done(V.event.request.done).fail(V.event.request.fail)},mockedXHR:function(){var x=false,v=false,t=false,w,u,s;s=h.Deferred().always(V.event.xhr.complete).done(V.event.xhr.done).fail(V.event.xhr.fail);if(K.mockResponse){if(h.isFunction(K.mockResponse)){V.debug("Using mocked callback returning response",K.mockResponse);u=K.mockResponse.call(S,K)}else{V.debug("Using specified response",K.mockResponse);u=K.mockResponse}s.resolveWith(S,[u,x,{responseText:u}])}else{if(h.isFunction(K.mockResponseAsync)){w=function(y){V.debug("Async callback returned response",y);if(y){s.resolveWith(S,[y,x,{responseText:y}])}else{s.rejectWith(S,[{responseText:y},v,t])}};V.debug("Using async mocked response",K.mockResponseAsync);K.mockResponseAsync.call(S,K,w)}}return s},xhr:function(){var s;s=h.ajax(H).always(V.event.xhr.always).done(V.event.xhr.done).fail(V.event.xhr.fail);V.verbose("Created server request",s);return s}},set:{error:function(){V.verbose("Adding error state to element",i);i.addClass(R.error)},loading:function(){V.verbose("Adding loading state to element",i);i.addClass(R.loading);N=new Date().getTime()}},remove:{error:function(){V.verbose("Removing error state from element",i);i.removeClass(R.error)},loading:function(){V.verbose("Removing loading state from element",i);i.removeClass(R.loading)}},get:{request:function(){return V.request||false},xhr:function(){return V.xhr||false},settings:function(){var s;s=K.beforeSend.call(S,K);if(s){if(s.success!==g){V.debug("Legacy success callback detected",s);V.error(Q.legacyParameters,s.success);s.onSuccess=s.success}if(s.failure!==g){V.debug("Legacy failure callback detected",s);V.error(Q.legacyParameters,s.failure);s.onFailure=s.failure}if(s.complete!==g){V.debug("Legacy complete callback detected",s);V.error(Q.legacyParameters,s.complete);s.onComplete=s.complete}}if(s===g){V.error(Q.noReturnedValue)}return(s!==g)?s:K},defaultData:function(){var s={};if(!h.isWindow(U)){if(V.is.input()){s.value=L.val()}else{if(!V.is.form()){}else{s.text=L.text()}}}return s},event:function(){if(h.isWindow(U)||K.on=="now"){V.debug("API called without element, no events attached");return false}else{if(K.on=="auto"){if(L.is("input")){return(U.oninput!==g)?"input":(U.onpropertychange!==g)?"propertychange":"keyup"}else{if(L.is("form")){return"submit"}else{return"click"}}}else{return K.on}}},templatedURL:function(s){s=s||L.data(l.action)||K.action||false;M=L.data(l.url)||K.url||false;if(M){V.debug("Using specified url",M);return M}if(s){V.debug("Looking up url for action",s,K.api);if(K.api[s]===g&&!V.is.mocked()){V.error(Q.missingAction,K.action,K.api);return}M=K.api[s]}else{if(V.is.form()){M=L.attr("action")||false;V.debug("No url or action specified, defaulting to form action",M)}}return M}},abort:function(){var s=V.get.xhr();if(s&&s.state()!=="resolved"){V.debug("Cancelling API request");s.abort()}},reset:function(){V.remove.error();V.remove.loading()},setting:function(t,s){V.debug("Changing setting",t,s);if(h.isPlainObject(t)){h.extend(true,K,t)}else{if(s!==g){K[t]=s}else{return K[t]}}},internal:function(t,s){if(h.isPlainObject(t)){h.extend(true,V,t)}else{if(s!==g){V[t]=s}else{return V[t]}}},debug:function(){if(K.debug){if(K.performance){V.performance.log(arguments)}else{V.debug=Function.prototype.bind.call(console.info,console,K.name+":");V.debug.apply(console,arguments)}}},verbose:function(){if(K.verbose&&K.debug){if(K.performance){V.performance.log(arguments)}else{V.verbose=Function.prototype.bind.call(console.info,console,K.name+":");V.verbose.apply(console,arguments)}}},error:function(){V.error=Function.prototype.bind.call(console.error,console,K.name+":");V.error.apply(console,arguments)},performance:{log:function(t){var u,s,v;if(K.performance){u=new Date().getTime();v=q||u;s=u-v;q=u;d.push({Name:t[0],Arguments:[].slice.call(t,1)||"","Execution Time":s})}clearTimeout(V.performance.timer);V.performance.timer=setTimeout(V.performance.display,500)},display:function(){var s=K.name+":",t=0;q=false;clearTimeout(V.performance.timer);h.each(d,function(v,u){t+=u["Execution Time"]});s+=" "+t+"ms";if(o){s+=" '"+o+"'"}if((console.group!==g||console.table!==g)&&d.length>0){console.groupCollapsed(s);if(console.table){console.table(d)}else{h.each(d,function(v,u){console.log(u.Name+": "+u["Execution Time"]+"ms")})}console.groupEnd()}d=[]}},invoke:function(y,v,t){var u=I,x,s,w;v=v||b;t=U||t;if(typeof y=="string"&&u!==g){y=y.split(/[\. ]/);x=y.length-1;h.each(y,function(z,A){var B=(z!=x)?A+y[z+1].charAt(0).toUpperCase()+y[z+1].slice(1):y;if(h.isPlainObject(u[B])&&(z!=x)){u=u[B]}else{if(u[B]!==g){s=u[B];return false}else{if(h.isPlainObject(u[A])&&(z!=x)){u=u[A]}else{if(u[A]!==g){s=u[A];return false}else{V.error(Q.method,y);return false}}}}})}if(h.isFunction(s)){w=s.apply(t,v)}else{if(s!==g){w=s}}if(h.isArray(p)){p.push(w)}else{if(p!==g){p=[p,w]}else{if(w!==g){p=w}}}return s}};if(r){if(I===g){V.initialize()}V.invoke(n)}else{if(I!==g){I.invoke("destroy")}V.initialize()}});return(p!==g)?p:this};h.api.settings={name:"API",namespace:"api",debug:true,verbose:false,performance:true,api:{},cache:true,interruptRequests:true,on:"auto",stateContext:false,loadingDuration:0,errorDuration:2000,action:false,url:false,base:"",urlData:{},defaultData:true,serializeForm:false,throttle:0,throttleFirstRequest:true,method:"get",data:{},dataType:"json",mockResponse:false,mockResponseAsync:false,beforeSend:function(a){return a},beforeXHR:function(a){},onRequest:function(a,b){},onResponse:false,onSuccess:function(b,a){},onComplete:function(b,a){},onFailure:function(b,a){},onError:function(b,a){},onAbort:function(b,a){},successTest:false,error:{beforeSend:"The before send function has aborted the request",error:"There was an error with your request",exitConditions:"API Request Aborted. Exit conditions met",JSONParse:"JSON could not be parsed during error handling",legacyParameters:"You are using legacy API success callback names",method:"The method you called is not defined",missingAction:"API action used but no url was defined",missingSerialize:"jquery-serialize-object is required to add form data to an existing data object",missingURL:"No URL specified for api event",noReturnedValue:"The beforeSend callback must return a settings object, beforeSend ignored.",noStorage:"Caching respopnses locally requires session storage",parseError:"There was an error parsing your request",requiredParameter:"Missing a required URL parameter: ",statusMessage:"Server gave an error: ",timeout:"Your request timed out"},regExp:{required:/\{\$*[A-z0-9]+\}/g,optional:/\{\/\$*[A-z0-9]+\}/g},className:{loading:"loading",error:"error"},selector:{disabled:".disabled",form:"form"},metadata:{action:"action",url:"url"}}})(jQuery,window,document);